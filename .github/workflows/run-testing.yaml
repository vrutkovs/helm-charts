name: "Test charts"

on:
  push:
    paths:
      - Makefile
      - 'charts/**'
      - 'test/**'
      - '!charts/*/lint/**'
      - '!**/*.md.gotmpl'
      - '!**/*.md'
      - '.github/workflows/run-testing.yaml'
    branches:
      - master
  pull_request:
    paths:
      - Makefile
      - 'charts/**'
      - 'test/**'
      - '!charts/*/lint/**'
      - '!**/*.md.gotmpl'
      - '!**/*.md'
      - '.github/workflows/run-testing.yaml'
    branches:
      - master

env:
  HELM_VERSION: 3.17.4

jobs:
  chart-tests:
    name: Run chart tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
      pull-requests: write
      statuses: write
    if: github.event.pull_request.draft == false
    strategy:
      matrix:
        k8s_version: ["v1.31.12", "v1.32.8", "v1.33.4"]
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Restore binaries from cache
        uses: actions/cache/restore@v4
        with:
          path: ./bin
          key: binary

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: "test/go.mod"
          check-latest: true
          cache: true
        id: go

      - name: Install go-junit-report
        run: |
          go install github.com/joschi/go-junit-report/v2/cmd/go-junit-report@latest

      - name: Install go-allure
        run: |
          go install github.com/robotomize/go-allure/cmd/golurectl@latest

      - name: Create Kind cluster
        uses: helm/kind-action@v1
        with:
          node_image: kindest/node:${{ matrix.k8s_version }}

      - name: Add helm repo dependencies
        run: yq -M eval '.repositories[] | (.name + " " + .url)' .github/ci/helm-repos.yaml | xargs -L 1 helm repo add

      - name: Run tests
        run: |
          cd test
          go test -json -p 1 ./... 2>&1 | golurectl -s -e -o /tmp/allure-results

      - name: Generate Allure Report
        if: success() || failure()
        run: |
          npm install allure
          npx allure generate /tmp/allure-results -o /tmp/allure-report

      - uses: actions/upload-artifact@v5
        id: upload-artifact
        if: success() || failure()
        with:
          name: report-${{ github.run_number }}-${{ matrix.k8s_version }}.html
          path: /tmp/allure-report/index.html
          retention-days: 7

      - name: Prepare binary cache
        uses: actions/cache@v4
        with:
          path: ./bin
          key: binary
